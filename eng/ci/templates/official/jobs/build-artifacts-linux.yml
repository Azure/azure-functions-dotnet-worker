jobs:
- job: BuildArtifactsLinux
  displayName: Build Linux Artifacts

  variables:
    project: src/WebJobs.Script.WebHost/WebJobs.Script.WebHost.csproj
    configuration: release
    runtime: linux-x64
    artifacts_path: $(Build.ArtifactStagingDirectory)
    log_dir: $(artifacts_path)/log
    zip_artifacts_path: $(artifacts_path)/Linux
    build_args: '-v m -c $(configuration) -r $(runtime) --self-contained true -p:BuildNumber=$(buildNumber)'

  templateContext:
    outputParentDirectory: $(artifacts_path)
    outputs:
    # TODO: onboard to Azure Artifacts Drops to allow accessing this from docker linux pipeline in msazure
    # https://eng.ms/docs/cloud-ai-platform/devdiv/one-engineering-system-1es/1es-docs/azure-artifacts/artifact-services-onboarding
    - output: pipelineArtifact
      displayName: Publish linux artifacts
      path: $(zip_artifacts_path)
      artifact: Linux
    - output: pipelineArtifact
      displayName: Publish logs
      path: $(log_dir)
      artifact: Linux_Log
      sbomEnabled: false
      condition: always()

  pool:
    name: 1es-pool-azfunc
    image: 1es-ubuntu-22.04
    os: linux

  steps:
  - template: /eng/ci/templates/install-dotnet.yml@self

  - task: DotNetCoreCLI@2
    displayName: Publish (net6.0)
    inputs:
      command: custom
      custom: publish
      publishWebProjects: false # we use our own publish logic
      zipAfterPublish: false # we use our own zip logic
      projects: $(project)
      arguments: '$(build_args) -f net6.0 -p:MinorVersionPrefix=6 -p:ZipArtifactsPath=$(zip_artifacts_path) -bl:$(log_dir)/publish.net6.binlog'

  - task: DotNetCoreCLI@2
    displayName: Publish (net8.0)
    inputs:
      command: custom
      custom: publish
      publishWebProjects: false # we use our own publish logic
      zipAfterPublish: false # we use our own zip logic
      projects: $(project)
      arguments: '$(build_args) -f net8.0 -p:MinorVersionPrefix=8 -p:ZipArtifactsPath=$(zip_artifacts_path) -bl:$(log_dir)/publish.net8.binlog'
