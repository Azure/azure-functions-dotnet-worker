jobs:

- job: BuildArtifacts
  displayName: Build artifacts

  templateContext:
    outputParentDirectory: $(Build.ArtifactStagingDirectory)
    outputs:
    - output: pipelineArtifact
      displayName: Publish nuget packages
      path: $(Build.ArtifactStagingDirectory)/NugetPackages
      artifact: NugetPackages

  pool:
    name: 1es-pool-azfunc
    image: 1es-windows-2022
    os: windows

  variables:
    ${{ if and( not(startsWith(variables['Build.SourceBranch'], 'refs/heads/release/')),  not(startsWith(variables['Build.SourceBranch'], 'refs/tags')) ) }}:
      buildNumberTemp: $(Build.BuildNumber)
    buildNumber: $[variables.buildNumberTemp]
    pack_dir: $(Build.ArtifactStagingDirectory)/NugetPackages

  steps:
  - template: /eng/ci/templates/steps/install-dotnet.yml@self

  - task: DotNetCoreCLI@2
    displayName: Build worker solution
    inputs:
      command: custom
      custom: build
      arguments: -p:BuildNumber=$(buildNumber) -c release
      projects: |
        DotNetWorker.sln

  - template: ci/sign-files.yml@eng
    parameters:
      displayName: Sign assemblies
      minimatch: true
      folderPath: ""
      pattern: |
        sdk/**/bin/**/Microsoft.Azure.Functions.Worker.Sdk*.dll
        sdk/**/bin/**/Microsoft.Azure.WebJobs.Extensions.FunctionMetadataLoader.dll
        src/**/bin/**/Microsoft.Azure.Functions.Worker*.dll
        src/**/bin/**/Azure.Functions.*.dll
      signType: dll

  - task: DeleteFiles@1
    displayName: Delete CodeSignSummary files
    inputs:
      sourceFolder: src
      contents: '**/CodeSignSummary-*.md'

  - task: DotNetCoreCLI@2
    displayName: Pack Projects
    inputs:
      command: custom
      custom: pack
      arguments: '--no-build -c release -o $(pack_dir) -p:BuildNumber=$(buildNumber)'
      projects: |
        sdk/**/Sdk*.csproj
        src/**/DotNetWorker*.csproj
        src/**/Azure.Functions.*.csproj

  - template: ci/sign-files.yml@eng
    parameters:
      displayName: Sign nuget packages
      folderPath: $(pack_dir)
      minimatch: true
      pattern: |
        Microsoft.Azure.Functions.Worker*.nupkg
        Azure.Functions.*.nupkg
      signType: nuget

  - task: DeleteFiles@1
    displayName: Delete CodeSignSummary files
    inputs:
      sourceFolder: $(pack_dir)
      contents: '**/CodeSignSummary-*.md'
