parameters:
- name: project
  type: string
  default: src/WebJobs.Script.SiteExtension/WebJobs.Script.SiteExtension.csproj
- name: publishDir
  type: string
  default: ''

steps:
- task: DotNetCoreCLI@2
  displayName: Restore site extension
  inputs:
    command: custom
    custom: restore
    projects: ${{ parameters.project }}
    arguments: '-v m -p:PublishReadyToRun=true'

- task: DotNetCoreCLI@2
  displayName: Publish site extension (net6)
  inputs:
    command: custom
    custom: publish
    publishWebProjects: false # we use our own publish logic
    zipAfterPublish: false # we use our own zip logic
    modifyOutputPath: false
    projects: ${{ parameters.project }}
    ${{ if eq(parameters.publishDir, '') }}:
      arguments: '-v m -c release --no-restore -f net6.0 -p:MinorVersionPrefix=6'
    ${{ else }}:
      arguments: '-v m -c release --no-restore -f net6.0 -p:MinorVersionPrefix=6 -o ${{ parameters.publishDir }}/net6'

- task: DotNetCoreCLI@2
  displayName: Publish site extension (net8)
  inputs:
    command: custom
    custom: publish
    publishWebProjects: false # we use our own publish logic
    zipAfterPublish: false # we use our own zip logic
    modifyOutputPath: false
    projects: ${{ parameters.project }}
    ${{ if eq(parameters.publishDir, '') }}:
      arguments: '-v m -c release --no-restore -f net8.0 -p:MinorVersionPrefix=8'
    ${{ else }}:
      arguments: '-v m -c release --no-restore -f net8.0 -p:MinorVersionPrefix=8 -o ${{ parameters.publishDir }}/net8'
