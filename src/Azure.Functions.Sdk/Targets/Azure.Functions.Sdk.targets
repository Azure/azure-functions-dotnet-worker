<!--
***********************************************************************************************
Azure.Functions.Sdk.targets

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
          created a backup copy.  Incorrect changes to this file will make it
          impossible to load or build your projects from the command-line or the IDE.

***********************************************************************************************
-->

<Project>

  <Import Sdk="Microsoft.NET.Sdk.Worker" Project="Sdk.targets" />
  <UsingTask TaskName="$(AzureFunctionsTaskNamespace).FuncSdkLog" AssemblyFile="$(AzureFunctionsSdkTasksAssembly)" />
  <UsingTask TaskName="$(AzureFunctionsTaskNamespace).GenerateWorkerConfig" AssemblyFile="$(AzureFunctionsSdkTasksAssembly)" />

  <PropertyGroup>
    <_AzureFunctionsVersionStandardized>$(AzureFunctionsVersion.ToLowerInvariant().Split('-')[0])</_AzureFunctionsVersionStandardized>
    <_FunctionsRuntimeMajorVersion>$(_AzureFunctionsVersionStandardized.TrimStart('vV'))</_FunctionsRuntimeMajorVersion>
    <_ToolingSuffix Condition="'$(TargetFrameworkIdentifier)' == '.NETCoreApp'">net$([MSBuild]::GetTargetFrameworkVersion('$(TargetFramework)', 1))-isolated</_ToolingSuffix>
    <_ToolingSuffix Condition="'$(TargetFrameworkIdentifier)' == '.NETFramework'">netfx-isolated</_ToolingSuffix>
    <FunctionsToolingSuffix Condition="'$(FunctionsToolingSuffix)' == ''">$(_ToolingSuffix)</FunctionsToolingSuffix>
  </PropertyGroup>

  <Import Project="$(MSBuildThisFileDirectory)Azure.Functions.Sdk.Analyzers.targets" />
  <Import Project="$(MSBuildThisFileDirectory)extensions/Azure.Functions.Sdk.Extensions.targets" />
  <Import Project="$(MSBuildFunctionsTargetsPath)Microsoft.Azure.Functions.Designtime.targets"
          Condition="Exists('$(MSBuildFunctionsTargetsPath)Microsoft.Azure.Functions.Designtime.targets')" />

  <Target Name="_ValidateFunctionsVersion">
    <ItemGroup>
      <_AllowedFunctionVersion Include="v4" InSupport="true" />
      <_SelectedFunctionVersion Include="@(_AllowedFunctionVersion)" Condition="'%(_AllowedFunctionVersion.Identity)' == '$(_AzureFunctionsVersionStandardized)'" />
    </ItemGroup>

    <PropertyGroup>
      <_MinimumSupportedTfmInFunctions>net8.0</_MinimumSupportedTfmInFunctions>
    </PropertyGroup>

    <FuncSdkLog Condition="'%(_SelectedFunctionVersion.InSupport)' == 'false'" Resource="Warning_EndOfLifeFunctionsVersion" Arguments="$(_AzureFunctionsVersionStandardized)" />
    <FuncSdkLog Condition="'@(_SelectedFunctionVersion)' == ''" Resource="Error_UnknownFunctionsVersion" Arguments="$(_AzureFunctionsVersionStandardized)" />
    <FuncSdkLog Condition="'$(TargetFrameworkIdentifier)' == '.NETCoreApp' AND !$([MSBuild]::IsTargetFrameworkCompatible('$(TargetFramework)', '$(_MinimumSupportedTfmInFunctions)'))"
      Resource="Warning_UnsupportedTargetFramework" Arguments="$(TargetFramework)" />
  </Target>

  <Target Name="_FunctionAppValidation" DependsOnTargets="_ValidateFunctionsVersion" BeforeTargets="Restore;Build" >
    <FuncSdkLog Condition="'$(_IsFunctionsSdkBuild)' == 'true'" Resource="Error_UsingLegacyFunctionsSdk" />
  </Target>

  <Target Name="_FunctionsCheckForCoreTools">
    <Exec Command="func --version" IgnoreExitCode="true">
      <Output TaskParameter="ExitCode" PropertyName="_FuncCliExitCode" />
    </Exec>

    <FuncSdkLog Condition="'$(_FuncCliExitCode)' != '0'" Resource="Error_CannotRunFuncCli" />
  </Target>

  <Target Name="_FunctionsComputeRunArguments" DependsOnTargets="_FunctionsCheckForCoreTools" BeforeTargets="ComputeRunArguments" >
    <!-- Windows Configuration -->
    <PropertyGroup Condition="'$(OS)' == 'Windows_NT'">
      <RunCommand>cmd</RunCommand>
      <RunArguments>/C func start $(RunArguments)</RunArguments>
      <RunWorkingDirectory>$(OutDir)</RunWorkingDirectory>
    </PropertyGroup>

    <!-- Unix/Linux/macOS Configuration -->
    <PropertyGroup Condition="'$(OS)' != 'Windows_NT'">
      <RunCommand>func</RunCommand>
      <RunArguments>start $(RunArguments)</RunArguments>
      <RunWorkingDirectory>$(OutDir)</RunWorkingDirectory>
    </PropertyGroup>
  </Target>

  <Target Name="_GenerateWorkerConfig" Condition="'$(NoBuild)' != 'true' AND '$(DesignTimeBuild)' != 'true'"
    DependsOnTargets="_PrepareWorkerConfig;_CoreGenerateWorkerConfig"
    BeforeTargets="GetCopyToOutputDirectoryItems;GetCopyToPublishDirectoryItems" />

  <Target Name="_PrepareWorkerConfig" Condition="'$(DesignTimeBuild)' != 'true'"
    DependsOnTargets="_ResolveFunctionExecutable;_PreGenerateWorkerConfig"
    BeforeTargets="GetCopyToOutputDirectoryItems;GetCopyToPublishDirectoryItems" />

  <Target Name="_ResolveFunctionExecutable" Returns="$(_FunctionsExecutable)">
    <PropertyGroup>
      <_FunctionsExecutable>dotnet</_FunctionsExecutable>
      <!-- If self-contained, get the name of the .exe to run. This also covers PublishAot scenarios. -->
      <_FunctionsExecutable Condition="'$(SelfContained)' == 'true'">{WorkerRoot}$(AssemblyName)$(_NativeExecutableExtension)</_FunctionsExecutable>
      <_FunctionsExecutable Condition="'$(TargetFrameworkIdentifier)' == '.NETFramework'">{WorkerRoot}$(TargetName)$(TargetExt)</_FunctionsExecutable>
    </PropertyGroup>
  </Target>

  <Target Name="_PreGenerateWorkerConfig" Returns="@(_WorkerConfig)">
    <PropertyGroup>
      <_WorkerConfigFileName>worker.config.json</_WorkerConfigFileName>
      <_WorkerConfigOutputPath>$(IntermediateOutputPath)$(_WorkerConfigFileName)</_WorkerConfigOutputPath>
    </PropertyGroup>

    <ItemGroup>
      <_WorkerConfig Include="$(_WorkerConfigOutputPath)" TargetPath="$(_WorkerConfigFileName)" />
      <ContentWithTargetPath Include="@(_WorkerConfig)" CopyToOutputDirectory="PreserveNewest" CopyToPublishDirectory="PreserveNewest" />
    </ItemGroup>
  </Target>

  <Target Name="_CoreGenerateWorkerConfig" Inputs="@(IntermediateAssembly)" Outputs="$(_WorkerConfigOutputPath)">
    <GenerateWorkerConfig Executable="$(_FunctionsExecutable)" EntryPoint="$(TargetFileName)" OutputPath="$(_WorkerConfigOutputPath)" />
  </Target>

</Project>
