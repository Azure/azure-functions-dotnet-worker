<!--
***********************************************************************************************
Azure.Functions.Sdk.Extensions.targets

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
          created a backup copy.  Incorrect changes to this file will make it
          impossible to load or build your projects from the command-line or the IDE.

***********************************************************************************************
-->

<Project>

  <UsingTask TaskName="$(AzureFunctionsTaskNamespace).Extensions.ResolveExtensionPackages" AssemblyFile="$(AzureFunctionsSdkTasksAssembly)" />
  <UsingTask TaskName="$(AzureFunctionsTaskNamespace).Extensions.ValidateExtensionPackages" AssemblyFile="$(AzureFunctionsSdkTasksAssembly)" />
  <UsingTask TaskName="$(AzureFunctionsTaskNamespace).Extensions.WriteExtensionProject" AssemblyFile="$(AzureFunctionsSdkTasksAssembly)" />

  <PropertyGroup>
    <_FunctionsPackageHashPath>$(_AzureFunctionsExtensionProjectDirectory)azure_functions.package.hash</_FunctionsPackageHashPath>
    <_FunctionsIntermediateExtensionJsonPath>$(IntermediateOutputPath)$(_FunctionsExtensionsJsonName)</_FunctionsIntermediateExtensionJsonPath>
    <_FunctionsUnusedPackagesCachePath>$(_AzureFunctionsExtensionProjectDirectory)azure_functions.unused_packages.cache</_FunctionsUnusedPackagesCachePath>
  </PropertyGroup>

  <Target Name="GenerateFunctionsExtensionProject" Condition="'$(DesignTimeBuild)' != 'true'"
    DependsOnTargets="CollectExtensionPackages;WriteExtensionProject;RestoreExtensionProject"
    AfterTargets="Restore" />

  <Target Name="CollectExtensionPackages" Returns="@(_AzureFunctionPackageReference)">
    <ResolveExtensionPackages ProjectAssetsFile="$(ProjectAssetsFile)">
      <Output TaskParameter="ExtensionPackages" ItemName="_AzureFunctionPackageReference" />
    </ResolveExtensionPackages>
  </Target>

  <!-- The WriteExtensionProject task will perform its own incremental build checks. -->
  <Target Name="WriteExtensionProject">
    <ValidateExtensionPackages ExtensionPackages="@(_AzureFunctionPackageReference)">
      <Output TaskParameter="FilteredPackages" ItemName="_ValidatedAzureFunctionPackageReference" />
    </ValidateExtensionPackages>
    <MakeDir Directories="$(_AzureFunctionsExtensionProjectDirectory)" Condition="!Exists('$(_AzureFunctionsExtensionProjectDirectory)')" />
    <WriteExtensionProject ExtensionPackages="@(_ValidatedAzureFunctionPackageReference)" ProjectPath="$(_AzureFunctionsExtensionProjectPath)"
      HashFilePath="$(_FunctionsPackageHashPath)" />
  </Target>

  <Target Name="RestoreExtensionProject">
    <MSBuild Projects="$(_AzureFunctionsExtensionProjectPath)" Targets="Restore"
      RemoveProperties="$(_AzureFunctionsExtensionRemoveProps)" Properties="IsRestoring=true;RestoreSources=$(_OutputSources)" />
  </Target>

</Project>
