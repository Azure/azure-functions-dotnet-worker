<!--
***********************************************************************************************
Azure.Functions.Sdk.Extensions.targets

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
          created a backup copy.  Incorrect changes to this file will make it
          impossible to load or build your projects from the command-line or the IDE.

***********************************************************************************************
-->

<Project>

  <UsingTask TaskName="$(AzureFunctionsTaskNamespace).Extensions.ResolveExtensionPackages" AssemblyFile="$(AzureFunctionsSdkTasksAssembly)" />
  <UsingTask TaskName="$(AzureFunctionsTaskNamespace).Extensions.ValidateExtensionPackages" AssemblyFile="$(AzureFunctionsSdkTasksAssembly)" />
  <UsingTask TaskName="$(AzureFunctionsTaskNamespace).Extensions.WriteExtensionProject" AssemblyFile="$(AzureFunctionsSdkTasksAssembly)" />
  <UsingTask TaskName="$(AzureFunctionsTaskNamespace).Extensions.WriteExtensionMetadata" AssemblyFile="$(AzureFunctionsSdkTasksAssembly)" />

  <PropertyGroup>
    <_FunctionsPackageHashPath>$(_AzureFunctionsExtensionProjectDirectory)azure_functions.package.hash</_FunctionsPackageHashPath>
    <_FunctionsIntermediateExtensionJsonPath>$(IntermediateOutputPath)$(_FunctionsExtensionsJsonName)</_FunctionsIntermediateExtensionJsonPath>
  </PropertyGroup>

  <Target Name="GenerateFunctionsExtensionProject" Condition="'$(DesignTimeBuild)' != 'true'"
    DependsOnTargets="CollectExtensionPackages;WriteExtensionProject;RestoreExtensionProject"
    AfterTargets="Restore" />

  <Target Name="PrepareFunctionsExtensionPayload" Condition="'$(DesignTimeBuild)' != 'true'"
    DependsOnTargets="GetFunctionsExtensionFiles;GenerateExtensionMetadata;AssignFunctionsTargetPaths"
    AfterTargets="CoreCompile" BeforeTargets="GetCopyToOutputDirectoryItems" />

  <Target Name="PublishFunctionsExtensionPayload" Condition="'$(DesignTimeBuild)' != 'true'"
    DependsOnTargets="GetFunctionsExtensionFiles;AssignFunctionsTargetPaths"
    BeforeTargets="GetCopyToPublishDirectoryItems" />

  <Target Name="CollectExtensionPackages" Returns="@(_AzureFunctionPackageReference)">
    <ResolveExtensionPackages ProjectAssetsFile="$(ProjectAssetsFile)">
      <Output TaskParameter="ExtensionPackages" ItemName="_AzureFunctionPackageReference" />
    </ResolveExtensionPackages>
  </Target>

  <!-- The WriteExtensionProject task will perform its own incremental build checks. -->
  <Target Name="WriteExtensionProject">
    <ValidateExtensionPackages ExtensionPackages="@(_AzureFunctionPackageReference)">
      <Output TaskParameter="FilteredPackages" ItemName="_ValidatedAzureFunctionPackageReference" />
    </ValidateExtensionPackages>
    <MakeDir Directories="$(_AzureFunctionsExtensionProjectDirectory)" Condition="!Exists('$(_AzureFunctionsExtensionProjectDirectory)')" />
    <WriteExtensionProject ExtensionPackages="@(_ValidatedAzureFunctionPackageReference)" ProjectPath="$(_AzureFunctionsExtensionProjectPath)"
      HashFilePath="$(_FunctionsPackageHashPath)" />
  </Target>

  <Target Name="RestoreExtensionProject">
    <MSBuild Projects="$(_AzureFunctionsExtensionProjectPath)" Targets="Restore"
      RemoveProperties="$(_AzureFunctionsExtensionRemoveProps)" Properties="IsRestoring=true;RestoreSources=$(_OutputSources)" />
    <Touch Files="$(_AzureFunctionsExtensionRestoredMarker)" AlwaysCreate="True" />
  </Target>

  <Target Name="GetFunctionsExtensionFiles" Returns="@(_FunctionsExtensionsOutputItems)">
    <MSBuild Projects="$(_AzureFunctionsExtensionProjectPath)" Targets="ResolveFunctionsExtensionFiles"
      RemoveProperties="$(_AzureFunctionsExtensionRemoveProps)">
      <Output TaskParameter="TargetOutputs" ItemName="_FunctionsExtensionsOutputItems" />
    </MSBuild>

    <ItemGroup>
      <_NoneWithTargetPath Include="@(_FunctionsExtensionsOutputItems)"
        CopyToOutputDirectory="PreserveNewest" CopyToPublishDirectory="PreserveNewest" />
    </ItemGroup>
  </Target>

  <Target Name="_CalculateFunctionsExtensionAssemblies">
    <ItemGroup>
      <_FunctionsExtensionAssemblies Include="@(_FunctionsExtensionsOutputItems->WithMetadataValue('AssetType', 'runtime'))" />
    </ItemGroup>
  </Target>

  <Target Name="GenerateExtensionMetadata" DependsOnTargets="_CalculateFunctionsExtensionAssemblies">
    <WriteExtensionMetadata OutputPath="$(_FunctionsIntermediateExtensionJsonPath)" ExtensionReferences="@(_FunctionsExtensionAssemblies)" />
  </Target>

  <Target Name="AssignFunctionsTargetPaths">
    <ItemGroup>
      <_NoneWithTargetPath Include="$(_FunctionsIntermediateExtensionJsonPath)" TargetPath="$(_FunctionsExtensionsJsonName)"
        CopyToOutputDirectory="PreserveNewest" CopyToPublishDirectory="PreserveNewest"/>
      <EmbedInBinlog Include="$(_FunctionsIntermediateExtensionJsonPath)" />
    </ItemGroup>
  </Target>

  <!--
    Until there is a consistent post-restore hook which gives a guarantee to run our targets after restore,
    _VerifyRestoredFunctionsExtensions will verify the restore hook has run. If extension restore hook has not
    run, this will emit a warning and try to perform the restore hook during build.
  -->
  <Target Name="_VerifyRestoredFunctionsExtensions" Condition="'$(DesignTimeBuild)' != 'true'"
    BeforeTargets="BeforeBuild"
    Inputs="$(_AzureFunctionsExtensionProjectPath);$(ProjectAssetsFile)" Outputs="$(_AzureFunctionsExtensionRestoredMarker)">
    <FuncSdkLog Resource="Warning_ExtensionsNotRestored" />
    <CallTarget Targets="GenerateFunctionsExtensionProject"/>
  </Target>

</Project>
