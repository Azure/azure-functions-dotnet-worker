<!--
***********************************************************************************************
Azure.Functions.Publish.targets

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
          created a backup copy.  Incorrect changes to this file will make it
          impossible to load or build your projects from the command-line or the IDE.

***********************************************************************************************
-->

<Project>

  <Import Project="$(MSBuildThisFileDirectory)Azure.Functions.Sdk.Publish.$(PublishProtocol).targets"
          Condition="Exists('$(MSBuildThisFileDirectory)Azure.Functions.Sdk.Publish.$(PublishProtocol).targets')" />

  <Target Name="AssignFunctionsBaseImage" DependsOnTargets="_FunctionsPreBuild"
    BeforeTargets="ComputeContainerBaseImage">
    <PropertyGroup>
      <ContainerBaseImage Condition="'$(ContainerBaseImage)' == ''">mcr.microsoft.com/azure-functions/dotnet-isolated:$(_FunctionsRuntimeMajorVersion)-dotnet-isolated$(TargetFrameworkVersion.TrimStart('vV'))</ContainerBaseImage>
      <ContainerWorkingDirectory Condition="'$(ContainerWorkingDirectory)' == ''">/home/site/wwwroot</ContainerWorkingDirectory>
      <!-- Functions base images only support amd64 runtimes -->
      <ContainerRuntimeIdentifier Condition="'$(ContainerRuntimeIdentifier)' == ''">linux-x64</ContainerRuntimeIdentifier>
    </PropertyGroup>

    <ItemGroup>
      <ContainerAppCommand Include="/opt/startup/start_nonappservice.sh" />
      <ContainerEnvironmentVariable Include="AzureWebJobsScriptRoot" Value="$(ContainerWorkingDirectory)"
        Condition="!@(ContainerEnvironmentVariable->AnyHaveMetadataValue('Identity', 'AzureWebJobsScriptRoot'))"/>
      <ContainerEnvironmentVariable Include="AzureFunctionsJobHost__Logging__Console__IsEnabled" Value="true"
        Condition="!@(ContainerEnvironmentVariable->AnyHaveMetadataValue('Identity', 'AzureFunctionsJobHost__Logging__Console__IsEnabled'))"/>
    </ItemGroup>
  </Target>

</Project>
